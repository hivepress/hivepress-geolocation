(function(a){"use strict";hivepress.initGeolocation=function(b){b.find(hivepress.getSelector("location")).each(function(){var b=a(this),c=b.closest("form"),d=b.find("input[type=text]"),f=c.find("input[data-coordinate=lat]"),g=c.find("input[data-coordinate=lng]"),h=c.find("input[data-region]"),i=[],j=b.find("a"),k={};if(d.data("region-types")&&(i=d.data("region-types")),"undefined"!=typeof mapboxData){k={accessToken:mapboxData.apiKey,language:hivepressCoreData.language},b.data("countries")&&(k.countries=b.data("countries").join(",")),b.data("types")&&(k.types=b.data("types").join(","));var l=new MapboxGeocoder(k);l.addTo(b.get(0));var m=b.children(".mapboxgl-ctrl"),n=d.prop("attributes");d.remove(),d=m.find("input[type=text]"),a.each(n,function(){d.attr(this.name,this.value)}),m.detach().prependTo(b),l.on("result",function(a){var b=i;h.length&&(a.result.place_type.filter(a=>b.includes(a)).length?h.val(a.result.id):h.val("")),g.val(a.result.geometry.coordinates[0]),f.val(a.result.geometry.coordinates[1]),d.data("address")&&(!d.val()&&d.val(d.data("address")),d.removeData("address"))})}else if(a.fn.geocomplete)k={details:c,detailsAttribute:"data-coordinate"},b.data("countries")&&(k.componentRestrictions={country:b.data("countries")}),b.data("types")&&(k.types=b.data("types")),d.geocomplete(k),d.bind("geocode:result",function(c,e){var f=[],g=i;h.length&&(e.address_components[0].types.filter(a=>g.includes(a)).length?h.val(e.place_id):h.val("")),d.data("address")&&(!d.val()&&d.val(d.data("address")),d.removeData("address")),b.data("scatter")&&(g.push("route"),a.each(e.address_components,function(a,b){b.types.filter(a=>g.includes(a)).length&&f.push(b.long_name)}),d.val(f.join(", ")))});else{k={language:hivepressCoreData.language,sessionToken:!1},b.data("countries")&&(k.includedRegionCodes=b.data("countries")),b.data("types")&&(k.includedPrimaryTypes=b.data("types"));var l=new google.maps.Geocoder;d.autocomplete({source:async function(b,c){var d=[];k.sessionToken||(k.sessionToken=new google.maps.places.AutocompleteSessionToken);const{suggestions:e}=await google.maps.places.AutocompleteSuggestion.fetchAutocompleteSuggestions(a.extend(k,{input:b.term}));for(let a of e)d.push({label:a.placePrediction.text.toString(),value:a.placePrediction});c(d)},select:async function(c,e){c.preventDefault();const j=e.item.value.toPlace();await j.fetchFields({fields:["location","addressComponents"]}),k.sessionToken=!1,d.val(e.item.label),f.val(j.location.lat),g.val(j.location.lng);var l=[],m=i;h.length&&(j.addressComponents[0].types.filter(a=>m.includes(a)).length?h.val(j.id):h.val("")),d.data("address")&&(!d.val()&&d.val(d.data("address")),d.removeData("address")),b.data("scatter")&&(m.push("route"),a.each(j.addressComponents,function(a,b){b.types.filter(a=>m.includes(a)).length&&l.push(b.longText)}),d.val(l.join(", ")))},open:function(){var b=a(this).autocomplete("widget");b.addClass("pac-container pac-logo hdpi").removeClass("ui-menu ui-widget ui-widget-content ui-autocomplete ui-front"),b.find("li").children("span").removeClass("ui-menu-item-wrapper ui-state-active"),b.width(d.outerWidth())}}),d.data("ui-autocomplete")._renderItem=function(b,c){return a("<li>").addClass("pac-item").append("<span class=\"pac-item-query\">"+c.label+"</span>").appendTo(b)}}d.on("input",function(){1>=d.val().length&&(c.find("input[data-coordinate]").val(""),h.length&&h.val(""))}),d.on("focusout",function(){!d.val()||f.val()&&g.val()||(d.data("address",d.val()),d.val(""))}),navigator.geolocation?j.on("click",function(b){navigator.geolocation.getCurrentPosition(function(b){"undefined"==typeof mapboxData?a.fn.geocomplete?d.geocomplete("find",b.coords.latitude+" "+b.coords.longitude):l.geocode({location:{lat:b.coords.latitude,lng:b.coords.longitude}},(a,b)=>{"OK"===b&&a.length&&d.val(a[0].formatted_address).focus().autocomplete("search")}):(l.options.reverseGeocode=!0,l.options.limit=1,l.query(b.coords.latitude+","+b.coords.longitude),l.options.reverseGeocode=!1,l.options.limit=5)}),b.preventDefault()}):j.hide()}),b.find(hivepress.getSelector("map")).each(function(){var b=a(this),c=b.width(),d=b.data("max-zoom"),e=b.data("marker");if(b.is("[data-height]")&&(c=b.data("height")),b.height(c),"undefined"!=typeof mapboxData){mapboxgl.accessToken=mapboxData.apiKey;var f=new mapboxgl.LngLatBounds,g=new mapboxgl.Map({container:b.get(0),style:"mapbox://styles/mapbox/streets-v11",center:[0,0],zoom:1});g.addControl(new mapboxgl.NavigationControl),g.addControl(new mapboxgl.FullscreenControl),g.addControl(new MapboxLanguage),a.each(b.data("markers"),function(a,b){f.extend([b.longitude,b.latitude]);new mapboxgl.Marker().setLngLat([b.longitude,b.latitude]).setPopup(new mapboxgl.Popup().setHTML(b.content)).addTo(g)}),g.fitBounds(f,{maxZoom:d-1,padding:50,duration:0});var h=new ResizeObserver(function(){g.resize(),g.fitBounds(f,{maxZoom:d-1,padding:50,duration:0})}).observe(b.get(0))}else{var i=!1,j=[],f=new google.maps.LatLngBounds,g=new google.maps.Map(b.get(0),{zoom:3,minZoom:2,maxZoom:d,mapTypeControl:!1,streetViewControl:!1,center:{lat:0,lng:0},styles:[{featureType:"poi",stylers:[{visibility:"off"}]}]}),k=new OverlappingMarkerSpiderfier(g,{markersWontMove:!0,markersWontHide:!0,basicFormatEvents:!0}),l={path:google.maps.SymbolPath.CIRCLE,fillColor:"#3a77ff",fillOpacity:.25,strokeColor:"#3a77ff",strokeWeight:1,strokeOpacity:.75,scale:10};a.each(b.data("markers"),function(a,c){var d=new google.maps.InfoWindow({content:c.content}),h={title:c.title,position:{lat:c.latitude,lng:c.longitude}};e&&(h.icon={url:e,scaledSize:new google.maps.Size(50,50)}),b.data("scatter")&&(h.icon=l);var m=new google.maps.Marker(h);m.addListener("spider_click",function(){i&&i.close(),i=d,d.open(g,m)}),j.push(m),k.addMarker(m),f.extend(m.getPosition())}),g.fitBounds(f);var h=new ResizeObserver(function(){g.fitBounds(f)}).observe(b.get(0)),m=new MarkerClusterer(g,j,{imagePath:hivepressGeolocationData.assetURL+"/images/markerclustererplus/m",maxZoom:d-1});b.data("scatter")&&g.addListener("zoom_changed",function(){var b=Math.pow;l.scale=b(1.3125,g.getZoom()),a.each(j,function(a){j[a].setIcon(l)})})}})},a(document).on("hivepress:init",function(a,b){hivepress.initGeolocation(b)})})(jQuery);