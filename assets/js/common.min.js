(function(a){"use strict";hivepress.initGeolocation=function(b){b.find(hivepress.getSelector("location")).each(function(){var b=a(this),c=b.closest("form"),d=b.find("input[type=text]"),f=c.find("input[data-coordinate=lat]"),g=c.find("input[data-coordinate=lng]"),h=c.find("input[data-region]"),i=b.find("a"),j={};if("undefined"!=typeof mapboxData){j={accessToken:mapboxData.apiKey,language:hivepressCoreData.language},b.data("countries")&&(j.countries=b.data("countries").join(",")),b.data("types")&&(j.types=b.data("types").join(","));var k=new MapboxGeocoder(j);k.addTo(b.get(0));var l=b.children(".mapboxgl-ctrl"),m=d.prop("attributes");d.remove(),d=l.find("input[type=text]"),a.each(m,function(){d.attr(this.name,this.value)}),l.detach().prependTo(b),k.on("result",function(a){var b=["place","district","region","country"];h.length&&(a.result.place_type.filter(a=>b.includes(a)).length?h.val(a.result.id):h.val("")),g.val(a.result.geometry.coordinates[0]),f.val(a.result.geometry.coordinates[1])})}else if(a.fn.geocomplete)j={details:c,detailsAttribute:"data-coordinate"},b.data("countries")&&(j.componentRestrictions={country:b.data("countries")}),b.data("types")&&(j.types=b.data("types")),d.geocomplete(j),d.bind("geocode:result",function(c,e){var f=[],g=["locality","administrative_area_level_2","administrative_area_level_1","country"];h.length&&(e.address_components[0].types.filter(a=>g.includes(a)).length?h.val(e.place_id):h.val("")),b.data("scatter")&&(g.push("route"),a.each(e.address_components,function(a,b){b.types.filter(a=>g.includes(a)).length&&f.push(b.long_name)}),d.val(f.join(", ")))});else{j={language:hivepressCoreData.language,sessionToken:!1},b.data("countries")&&(j.includedRegionCodes=b.data("countries")),b.data("types")&&(j.includedPrimaryTypes=b.data("types"));var k=new google.maps.Geocoder;d.autocomplete({source:async function(b,c){var d=[];j.sessionToken||(j.sessionToken=new google.maps.places.AutocompleteSessionToken);const{suggestions:e}=await google.maps.places.AutocompleteSuggestion.fetchAutocompleteSuggestions(a.extend(j,{input:b.term}));for(let a of e)d.push({label:a.placePrediction.text.toString(),value:a.placePrediction});c(d)},select:async function(c,e){c.preventDefault();const i=e.item.value.toPlace();await i.fetchFields({fields:["location","addressComponents"]}),j.sessionToken=!1,d.val(e.item.label),f.val(i.location.lat),g.val(i.location.lng);var k=[],l=["locality","administrative_area_level_2","administrative_area_level_1","country"];h.length&&(i.addressComponents[0].types.filter(a=>l.includes(a)).length?h.val(i.id):h.val("")),b.data("scatter")&&(l.push("route"),a.each(i.addressComponents,function(a,b){b.types.filter(a=>l.includes(a)).length&&k.push(b.longText)}),d.val(k.join(", ")))}})}d.on("input",function(){1>=d.val().length&&(c.find("input[data-coordinate]").val(""),h.length&&h.val(""))}),d.on("focusout",function(){f.val()&&g.val()||d.val("")}),navigator.geolocation?i.on("click",function(b){navigator.geolocation.getCurrentPosition(function(b){"undefined"==typeof mapboxData?a.fn.geocomplete?d.geocomplete("find",b.coords.latitude+" "+b.coords.longitude):k.geocode({location:{lat:b.coords.latitude,lng:b.coords.longitude}},(a,b)=>{"OK"===b&&a.length&&d.val(a[0].formatted_address).focus().autocomplete("search")}):(k.options.reverseGeocode=!0,k.options.limit=1,k.query(b.coords.latitude+","+b.coords.longitude),k.options.reverseGeocode=!1,k.options.limit=5)}),b.preventDefault()}):i.hide()}),b.find(hivepress.getSelector("map")).each(function(){var b=a(this),c=b.width(),d=b.data("max-zoom"),e=b.data("marker");if(b.is("[data-height]")&&(c=b.data("height")),b.height(c),"undefined"!=typeof mapboxData){mapboxgl.accessToken=mapboxData.apiKey;var f=new mapboxgl.LngLatBounds,g=new mapboxgl.Map({container:b.get(0),style:"mapbox://styles/mapbox/streets-v11",center:[0,0],zoom:1});g.addControl(new mapboxgl.NavigationControl),g.addControl(new mapboxgl.FullscreenControl),g.addControl(new MapboxLanguage),a.each(b.data("markers"),function(a,b){f.extend([b.longitude,b.latitude]);new mapboxgl.Marker().setLngLat([b.longitude,b.latitude]).setPopup(new mapboxgl.Popup().setHTML(b.content)).addTo(g)}),g.fitBounds(f,{maxZoom:d-1,padding:50,duration:0});var h=new ResizeObserver(function(){g.resize(),g.fitBounds(f,{maxZoom:d-1,padding:50,duration:0})}).observe(b.get(0))}else{var i=!1,j=[],f=new google.maps.LatLngBounds,g=new google.maps.Map(b.get(0),{zoom:3,minZoom:2,maxZoom:d,mapTypeControl:!1,streetViewControl:!1,center:{lat:0,lng:0},styles:[{featureType:"poi",stylers:[{visibility:"off"}]}]}),k=new OverlappingMarkerSpiderfier(g,{markersWontMove:!0,markersWontHide:!0,basicFormatEvents:!0}),l={path:google.maps.SymbolPath.CIRCLE,fillColor:"#3a77ff",fillOpacity:.25,strokeColor:"#3a77ff",strokeWeight:1,strokeOpacity:.75,scale:10};a.each(b.data("markers"),function(a,c){var d=new google.maps.InfoWindow({content:c.content}),h={title:c.title,position:{lat:c.latitude,lng:c.longitude}};e&&(h.icon={url:e,scaledSize:new google.maps.Size(50,50)}),b.data("scatter")&&(h.icon=l);var m=new google.maps.Marker(h);m.addListener("spider_click",function(){i&&i.close(),i=d,d.open(g,m)}),j.push(m),k.addMarker(m),f.extend(m.getPosition())}),g.fitBounds(f);var h=new ResizeObserver(function(){g.fitBounds(f)}).observe(b.get(0)),m=new MarkerClusterer(g,j,{imagePath:hivepressGeolocationData.assetURL+"/images/markerclustererplus/m",maxZoom:d-1});b.data("scatter")&&g.addListener("zoom_changed",function(){var b=Math.pow;l.scale=b(1.3125,g.getZoom()),a.each(j,function(a){j[a].setIcon(l)})})}})},a(document).on("hivepress:init",function(a,b){hivepress.initGeolocation(b)})})(jQuery);